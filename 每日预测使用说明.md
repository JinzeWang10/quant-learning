# 每日股票预测使用说明

## 📋 功能概述

`predict_today.py` 是一个轻量级的每日预测工具，用于：
- ✅ **增量更新**数据（只获取最新几天，不重复下载历史数据）
- ✅ 使用训练好的模型预测所有股票的上涨概率
- ✅ 生成Excel文件，按概率排序展示预测结果

---

## 🚀 使用步骤

### 第一步：首次训练模型（仅需一次）

```bash
python final_strategy.py
```

这会：
1. 加载历史数据
2. 训练随机森林模型
3. 保存模型到 `rf_model.pkl`
4. 运行回测验证策略

⚠️ **注意**：只有在以下情况需要重新训练：
- 首次使用
- 想要更新训练数据（比如每月重训一次）
- 修改了特征工程或模型参数

---

### 第二步：每日预测（每天运行）

```bash
python predict_today.py
```

这会：
1. 加载已训练的模型 `rf_model.pkl`
2. 登录 baostock
3. **增量更新**所有股票数据（只获取最新数据追加到现有CSV）
4. 计算技术指标特征
5. 预测每只股票的上涨概率
6. 生成Excel文件：`stock_predictions_YYYYMMDD.xlsx`

---

## 📊 Excel文件说明

生成的Excel包含3个工作表：

### 1️⃣ **完整预测** - 所有股票预测结果

| 列名 | 说明 |
|------|------|
| 排名 | 按预测概率从高到低排序 |
| 股票代码 | 6位数字代码 |
| 股票名称 | 中文名称 |
| 预测概率 | 模型预测的上涨概率（0-1之间） |
| 数据日期 | 最新数据的日期 |
| 收盘价 | 最新收盘价 |
| 开盘价 | 最新开盘价 |
| 5日涨幅 | 过去5个交易日的涨跌幅 |
| 20日涨幅 | 过去20个交易日的涨跌幅 |
| RSI | 相对强弱指标（0-100） |
| 量比 | 当日成交量/5日平均成交量 |
| 布林带位置 | 价格在布林带的位置（0-1） |
| MACD | MACD指标值 |

### 2️⃣ **高概率股票（≥60%）** - 重点关注

只包含预测概率 ≥ 60% 的股票，这些是模型最看好的标的。

### 3️⃣ **中等概率股票（55%-60%）** - 备选池

预测概率在 55%-60% 之间的股票，可作为备选。

---

## 📈 使用建议

### 1. 查看预测结果

打开Excel文件后：
- 优先查看 **"高概率股票(≥60%)"** 工作表
- 关注 **Top 5-10** 的股票
- 结合其他指标（RSI、量比等）综合判断

### 2. 交易时机建议

**开盘前（9:15之前）运行**：
```bash
python predict_today.py
```
- 此时获取的是昨日收盘数据
- 用于决策今日开盘是否买入

**盘中更新（可选）**：
- 如果想获取今日开盘后的数据，可以在 9:35 之后再运行一次
- 此时会包含今日开盘价和最新行情

### 3. 风险控制

⚠️ **重要提示**：
- 预测概率只是参考，不保证一定上涨
- 建议设置止损位（如 -3% 止损）
- 分散投资，不要全仓单只股票
- 结合市场大盘走势综合判断

---

## 🔧 技术细节

### 增量更新机制

脚本会智能判断：
1. 如果CSV文件存在 → 读取最后日期，只获取之后的新数据
2. 如果CSV文件不存在 → 获取最近10天数据
3. 自动去重和排序，确保数据完整性

**好处**：
- ⚡ 速度快（只下载新数据，不重复下载历史）
- 💾 节省流量
- 🔄 数据始终保持最新

### 数据来源

- **数据源**：baostock
- **复权方式**：后复权
- **数据频率**：日线

---

## ❓ 常见问题

### Q1: 运行时报错 "模型文件不存在"

**A**: 需要先运行 `python final_strategy.py` 训练并保存模型

### Q2: 某些股票更新失败

**A**: 可能原因：
- 股票停牌
- baostock数据暂时不可用
- 网络问题

脚本会自动跳过失败的股票，不影响其他股票预测。

### Q3: 预测概率都比较低（<55%）

**A**: 这说明当前市场环境下，模型认为没有高确定性的上涨机会，建议：
- 持币观望
- 或降低仓位谨慎参与

### Q4: 多久重新训练一次模型？

**A**: 建议：
- **每月重训一次**：保持模型与市场环境同步
- 或当策略表现不佳时重新训练
- 训练时会自动覆盖旧的 `rf_model.pkl`

### Q5: 可以在盘中运行吗？

**A**: 可以！
- baostock通常在盘中也能获取最新数据
- 但建议在 **9:35之后** 运行，让开盘价稳定
- 或在 **收盘后** 运行，获取完整当日数据

---

## 📅 日常工作流程

### 方案A：开盘前决策（推荐）

```
时间：09:00-09:15
操作：python predict_today.py
目的：基于昨日数据决定今日开盘买入
```

### 方案B：盘中更新

```
时间：09:35-10:00
操作：python predict_today.py
目的：获取今日开盘后最新数据调整决策
```

### 方案C：收盘后分析

```
时间：15:05-16:00
操作：python predict_today.py
目的：获取完整当日数据，为次日做准备
```

---

## 📝 输出示例

### 终端输出

```
================================================================================
📊 每日股票上涨概率预测
================================================================================
运行时间: 2024-01-08 09:15:23

[1/4] 📦 加载模型...
  ✓ 模型加载成功
  ✓ 股票池: 30 只
  ✓ 特征数: 25 个

[2/4] 🔐 登录 baostock...
  ✓ 登录成功

[3/4] 📈 增量更新股票数据...
  进度: 10/30 (33.3%) - 600036 招商银行
  进度: 20/30 (66.7%) - 601318 中国平安
  进度: 30/30 (100.0%) - 601888 中国中免

  ✓ 数据更新完成: 成功 28/30, 失败 2

[4/4] 📊 生成预测Excel...
  ✓ Excel已生成: stock_predictions_20240108.xlsx

================================================================================
📊 预测结果摘要
================================================================================
总股票数: 28
平均预测概率: 52.34%

概率分布:
  ≥ 65%: 2 只
  ≥ 60%: 5 只
  ≥ 55%: 12 只
  ≥ 50%: 18 只

================================================================================
🏆 Top 10 预测股票
================================================================================
排名     代码         名称           概率        收盘价      5日涨幅
--------------------------------------------------------------------------------
1      600036     招商银行       67.82%    42.50      8.45%
2      601318     中国平安       64.23%    51.20      5.67%
...
```

---

## 🎯 总结

使用 `predict_today.py` 可以：
- ✅ 每天快速获取最新预测（1-2分钟）
- ✅ 自动增量更新数据，无需重复下载
- ✅ 生成Excel报表，方便查看和分析
- ✅ 辅助交易决策，提高选股效率

**记住**：模型预测仅供参考，投资需谨慎！
