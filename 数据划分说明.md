# 随机森林策略 - 数据划分说明

## ✅ 已修复：防止数据泄露

### 问题诊断

**原版本的严重问题**：
```python
# ❌ 错误做法：随机划分
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
```

**问题**：
1. **时间泄露** - 训练集可能包含未来数据，测试集包含过去数据
2. **回测数据泄露** - 模型在训练时已经"见过"回测期的数据
3. **过拟合** - 训练数据和回测数据100%重合

---

## ✅ 修复后的正确做法

### 时间序列划分

```
完整数据: 2023-01-01 ~ 2024-10-18 (约660天)

├─ 训练集: 2023-01-01 ~ 2024-06-30 (约18个月)
│   └─ 用途: 训练随机森林模型
│
├─ 测试集: 2024-07-01 ~ 2024-10-18 (约3.5个月)
│   └─ 用途: 评估模型泛化能力
│
└─ 回测期: 2024-07-01 ~ 2024-10-18 (与测试集一致)
    └─ 用途: 模拟实盘交易

⚠️ 关键：回测期 = 测试集，模型从未见过这些数据！
```

### 代码实现

```python
# 时间划分
TRAIN_START = '2023-01-01'
TRAIN_END = '2024-06-30'
TEST_START = '2024-07-01'
TEST_END = '2024-10-18'

# 训练模型
predictor.train_model(
    stock_pool,
    train_start=TRAIN_START,
    train_end=TRAIN_END,
    test_start=TEST_START,
    test_end=TEST_END
)

# 回测（仅在测试期）
run_backtest(
    stock_pool=stock_pool,
    predictor=predictor,
    backtest_start=TEST_START,  # 与测试集一致
    backtest_end=TEST_END
)
```

---

## 📊 数据流程

### 1. 训练阶段
```
CSV文件
  → 按日期筛选 (2023-01-01 ~ 2024-06-30)
  → 计算特征
  → 训练RandomForest
  → 在测试集上评估
```

### 2. 回测阶段
```
CSV文件
  → 按日期筛选 (2024-07-01 ~ 2024-10-18)
  → 逐日预测
  → 概率>60%买入，<40%卖出
  → 计算收益
```

---

## 🔍 验证无数据泄露

### 检查点

1. **训练数据日期范围**
   ```
   训练集最大日期 < 测试集最小日期
   2024-06-30 < 2024-07-01 ✓
   ```

2. **回测数据独立性**
   ```
   回测期 == 测试期
   模型训练时未见过这些数据 ✓
   ```

3. **时间顺序严格**
   ```
   训练集 → 测试集 → 无重叠 ✓
   ```

---

## 📈 回测结果解读

### 可信度分析

**高可信度** ✓
- 训练集和测试集按时间严格划分
- 回测期数据模型从未见过
- 符合真实交易场景

**注意事项**
- 测试集仅3.5个月，样本较少
- 建议使用更长的回测期验证策略稳定性
- 可以进行**滚动窗口回测**进一步验证

---

## 🔧 如何调整时间划分

修改 `backtest_rf_strategy.py` 中的常量：

```python
# 在 main() 函数中
TRAIN_START = '2023-01-01'  # 训练开始
TRAIN_END = '2024-06-30'    # 训练结束
TEST_START = '2024-07-01'   # 测试/回测开始
TEST_END = '2024-10-18'     # 测试/回测结束
```

### 推荐配置

| 场景 | 训练期 | 测试期 | 说明 |
|------|--------|--------|------|
| **快速验证** | 12个月 | 3个月 | 当前配置 |
| **稳定测试** | 18个月 | 6个月 | 推荐 |
| **长期验证** | 24个月 | 12个月 | 数据充足时 |

---

## 🎯 总结

### 修复前 ❌
- 随机划分，存在数据泄露
- 回测结果虚高，不可信
- 实盘会严重亏损

### 修复后 ✅
- 时间序列划分，无数据泄露
- 回测结果真实可信
- 可以安全用于实盘参考

---

## 📚 参考

- [时间序列交叉验证](https://scikit-learn.org/stable/modules/cross_validation.html#time-series-split)
- [避免数据泄露的最佳实践](https://www.kaggle.com/code/alexisbcook/data-leakage)
