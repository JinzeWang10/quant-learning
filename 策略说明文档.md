# 基于随机森林的沪深 300 选股策略

## 策略概述

本策略采用机器学习方法，通过随机森林模型预测沪深 300 成分股的短期上涨概率，实现动态选股与择时交易。策略核心在于利用技术指标特征预测未来 5 日收益率，并根据预测概率进行单股票集中持仓。

**策略类型**: 量化选股 + 机器学习
**股票池**: 沪深 300 成分股（约 300 只）
**持仓方式**: 单股票集中持仓（95%仓位）
**预测目标**: 未来 5 日涨幅>3%的概率
**回测区间**: 2025-07-01 至 2025-11-21

---

## 策略逻辑

### 1. 股票池选择

**沪深 300 指数成分股**

- 市值范围：大盘至中盘股
- 行业分布：金融(60)、消费(50)、科技(50)、医药(40)、新能源(30)、周期(40)、能源(20)、工业(30)、地产(10)、传媒(10)

**选择理由**：

1. 样本充足：300 只股票提供足够的训练数据
2. 风格均衡：覆盖大中盘股，兼顾稳健与成长
3. 流动性好：日均成交占市场 50%以上，无流动性风险
4. 代表性强：反映中国核心资产，与市场整体走势相关性高

### 2. 特征工程

策略使用 10 个技术指标特征，分为历史特征和开盘特征两类，确保所有特征在开盘时刻均可获得，避免未来函数。

#### 历史特征（基于 T-1 日及之前数据）

| 特征名称             | 计算方法                                                       | 含义                       |
| -------------------- | -------------------------------------------------------------- | -------------------------- |
| `return_1d_prev`     | close[t-1]/close[t-2] - 1                                      | 昨日收益率（短期动量）     |
| `return_5d_prev`     | close[t-1]/close[t-6] - 1                                      | 5 日收益率（中期动量）     |
| `return_10d_prev`    | close[t-1]/close[t-11] - 1                                     | 10 日收益率（长期动量）    |
| `ma_ratio_5_20_prev` | MA5[t-1] / MA20[t-1]                                           | 均线比值（趋势强度）       |
| `volume_ratio_prev`  | volume[t-1] / MA5(volume)[t-1]                                 | 成交量比（量能变化）       |
| `rsi_prev`           | RSI(14)[t-1]                                                   | 相对强弱指标（超买超卖）   |
| `volatility_prev`    | std(return_1d, 20)[t-1]                                        | 历史波动率（风险度量）     |
| `bb_position_prev`   | (close[t-1] - BB_lower[t-1]) / (BB_upper[t-1] - BB_lower[t-1]) | 布林带位置（价格相对强度） |

#### 开盘特征（基于 T 日开盘价）

| 特征名称      | 计算方法                 | 含义                     |
| ------------- | ------------------------ | ------------------------ |
| `open_gap`    | open[t] / close[t-1] - 1 | 开盘跳空（隔夜效应）     |
| `open_vs_ma5` | open[t] / MA5[t-1] - 1   | 开盘相对强度（盘口信号） |

**特征设计原则**：

- 时间对齐：历史特征使用`shift(1)`后移，开盘特征基于当日开盘价
- 多维度：涵盖价格、成交量、趋势、波动、位置等多个维度
- 可获得性：所有特征在开盘时刻即可计算，无未来数据泄露

### 3. 模型训练

**算法**: RandomForestClassifier（随机森林分类器）

**模型参数**:

```python
n_estimators = 100          # 决策树数量
max_depth = 10              # 树深度（防止过拟合）
random_state = 42           # 随机种子（可复现）
class_weight = 'balanced'   # 样本权重平衡
n_jobs = -1                 # 并行计算
```

**标签定义**:

```python
label = 1  if  (close[t+5] / close[t] - 1) > 0.03
label = 0  otherwise
```

即：未来 5 日涨幅>3%为正样本，否则为负样本

**训练数据**:

- 时间范围：2022-01-01 至 2025-06-30（3.5 年）
- 样本量：约 25 万条（300 只股票 × 850 个交易日）
- 数据处理：去除 NaN 值、时间序列对齐、特征标准化

**特征重要性**（Top 5）:

1. `rsi_prev` - RSI 指标（超买超卖信号最重要）
2. `return_5d_prev` - 5 日动量（中期趋势）
3. `open_gap` - 开盘跳空（隔夜信息）
4. `volume_ratio_prev` - 量比（资金流向）
5. `ma_ratio_5_20_prev` - 均线位置（趋势确认）

### 4. 交易规则

#### 开仓规则

**条件**：

1. 当前无持仓
2. 遍历沪深 300 所有股票，计算上涨概率
3. 筛选概率 > `buy_threshold`（60%）的候选股票
4. 选择概率最高的股票

**执行**：

- 使用账户总值的 95%买入
- 按 100 股整数倍下单
- 以当日开盘价成交（`cheat_on_open`模式）

#### 平仓规则

**条件**：

1. 持有股票
2. 每日开盘前计算持仓股票的上涨概率
3. 若概率 < `sell_threshold`（50%），触发止损

**执行**：

- 全部卖出持仓
- 以当日开盘价成交

#### 持仓管理

**仓位控制**：

- 单股票仓位：95%（保留 5%现金应对手续费）
- 持仓数量：0 或 1 只股票（集中持仓）

**阈值设计**：

- `buy_threshold = 0.60`：买入概率阈值，确保有足够把握
- `sell_threshold = 0.50`：卖出概率阈值，及时止损
- 10%缓冲区：避免频繁交易，减少摩擦成本

### 5. 风险控制

**交易成本**：

- 手续费：0.1%（单边）
- 滑点：假设以开盘价成交，实际可能有偏差

**风险点**：

1. **模型风险**：过拟合、特征失效
2. **市场风险**：系统性下跌、黑天鹅事件
3. **集中持仓风险**：单股票暴跌无对冲
4. **执行风险**：涨跌停无法成交、停牌

**缓解措施**：

- 严格时间序列分割（训练集与测试集无重叠）
- 特征有效性验证（相关性分析、重要性排序）
- 概率阈值过滤（只买高概率股票）
- 及时止损（概率<50%立即离场）

---

## 回测结果

### 回测设置

| 参数     | 值                            |
| -------- | ----------------------------- |
| 初始资金 | 100,000 元                    |
| 回测区间 | 2025-07-01 至 2025-11-21      |
| 股票池   | 沪深 300 成分股（298 只有效） |
| 买入阈值 | 60%                           |
| 卖出阈值 | 50%                           |
| 仓位比例 | 95%                           |
| 手续费率 | 0.1%                          |

### 绩效指标

| 指标         | 数值    |
| ------------ | ------- |
| 总收益率     | +XX.XX% |
| 年化收益率   | +XX.XX% |
| 最大回撤     | -XX.XX% |
| 夏普比率     | X.XX    |
| 交易次数     | XX 次   |
| 胜率         | XX.XX%  |
| 盈亏比       | X.XX    |
| 平均持仓天数 | X.X 天  |

### 交易统计

**收益分布**：

- 盈利次数：XX 次
- 亏损次数：XX 次
- 最大单笔盈利：+XX.XX%
- 最大单笔亏损：-XX.XX%
- 平均单笔收益：+X.XX%

**时间分布**：

- 平均持仓周期：X 天
- 最长持仓：XX 天
- 最短持仓：X 天
- 空仓时间占比：XX%

---

## 使用指南

### 环境要求

**Python 版本**: 3.8+

**依赖库**:

```bash
pip install pandas numpy backtrader scikit-learn matplotlib seaborn baostock
```

### 运行步骤

#### 步骤 1：下载数据

```bash
python download_stock_data_baostock.py
```

选择：

1. 运行模式 → `2` (下载指数成分股)
2. 指数选择 → `2` (沪深 300)

输出：

- 下载沪深 300 成分股列表（约 300 只）
- 下载历史 K 线数据（2022-01-01 至今）
- 保存至`stock_data/`目录
- 下载上证指数、沪深 300 指数数据（用于基准对比）

#### 步骤 2：运行回测

```bash
python final_strategy.py
```

执行流程：

1. 加载沪深 300 成分股数据
2. 特征有效性分析
3. 训练随机森林模型
4. 运行回测（2025-07-01 至 2025-11-21）
5. 输出绩效指标和交易明细
6. 生成可视化图表

#### 步骤 3：查看结果

**控制台输出**：

- 特征统计（均值、标准差、缺失率）
- 特征相关性（高相关特征对）
- 模型训练结果（准确率、特征重要性）
- 回测交易日志（每笔买卖详情）
- 绩效汇总（收益率、胜率、最大回撤等）

**生成文件**：

- `feature_correlation_heatmap.png` - 特征相关性热图
- `feature_importance.png` - 特征重要性柱状图
- `backtest_visualization.png` - 资金曲线与上证指数对比

---

## 代码结构

```
final_strategy.py
├── 数据处理模块
│   ├── get_stock_data()          # 读取股票CSV数据
│   ├── calculate_features()      # 计算10个技术指标
│   ├── prepare_training_data()   # 准备训练集
│   └── analyze_feature_validity() # 特征有效性分析
├── 模型训练模块
│   └── train_rf_model()          # 训练随机森林
├── 策略模块
│   ├── RFBestStockStrategy       # Backtrader策略类
│   │   ├── next_open()           # 每日开盘前执行
│   │   ├── get_stock_probability() # 计算股票上涨概率
│   │   └── notify_order()        # 订单状态回调
│   └── PandasData                # 数据源适配器
├── 回测模块
│   ├── run_backtest()            # 运行Backtrader回测
│   ├── plot_backtest_results()   # 绘制可视化图表
│   └── get_index_data()          # 获取指数数据
└── 主程序
    └── main()                     # 程序入口

hs300_stocks.py
└── get_hs300_stock_pool()        # 返回沪深300成分股字典
```

---

## 参数调整

### 买卖阈值

**当前设置**：

```python
buy_threshold = 0.60   # 60%
sell_threshold = 0.50  # 50%
```

**调整建议**：

- 更保守：`buy_threshold=0.70, sell_threshold=0.55` → 提高准确率，减少交易次数
- 更激进：`buy_threshold=0.55, sell_threshold=0.45` → 增加交易次数，可能降低胜率

### 仓位比例

**当前设置**：

```python
position_ratio = 0.95  # 95%
```

**调整建议**：

- 保守型：`0.80` → 保留更多现金，降低波动
- 激进型：`0.98` → 接近满仓，最大化收益

### 预测目标

**当前设置**：

```python
df['label'] = (df['close'].shift(-5) / df['close'] - 1 > 0.03).astype(int)
```

**调整建议**：

- 短周期：`shift(-3), > 0.02` → 3 日涨幅>2%
- 长周期：`shift(-10), > 0.05` → 10 日涨幅>5%

### 模型参数

**当前设置**：

```python
RandomForestClassifier(
    n_estimators=100,
    max_depth=10,
    random_state=42
)
```

**调整建议**：

- 更复杂：`n_estimators=200, max_depth=15` → 提高拟合能力，注意过拟合
- 更简单：`n_estimators=50, max_depth=5` → 降低复杂度，提高泛化

---

## 优化方向

### 1. 特征增强

**基本面特征**：

- 市盈率（PE）、市净率（PB）、ROE
- 营收增长率、净利润增长率
- 资产负债率、现金流

**资金流特征**：

- 北向资金净流入
- 融资融券余额
- 大单流入流出

**情绪指标**：

- 换手率、振幅
- 涨停板数量
- 市场情绪指数（恐慌指数）

**宏观因素**：

- 利率、汇率
- 行业景气度指数
- 市场整体估值水平

### 2. 模型改进

**集成学习**：

```python
# 多模型投票
rf = RandomForestClassifier()
xgb = XGBClassifier()
lgb = LGBMClassifier()

# 加权平均概率
prob = 0.4*rf.predict_proba() + 0.3*xgb.predict_proba() + 0.3*lgb.predict_proba()
```

**深度学习**：

- LSTM：捕捉时间序列依赖
- Transformer：自注意力机制
- CNN：提取局部模式

**特征选择**：

- RFE（递归特征消除）
- LASSO（L1 正则化）
- 基于重要性的筛选

### 3. 策略优化

**多股持仓**：

```python
# Top3持仓，每只30%
top3 = sorted(candidates, key=lambda x: x['prob'], reverse=True)[:3]
for stock in top3:
    buy(stock, size=account_value * 0.30)
```

**动态仓位**：

```python
# 根据概率调整仓位
if prob > 0.70: position = 0.95
elif prob > 0.65: position = 0.80
elif prob > 0.60: position = 0.60
```

**止损止盈**：

```python
# 固定比例止损止盈
if profit_pct < -5%: sell()   # 止损
if profit_pct > 10%: sell()   # 止盈
```

**行业轮动**：

```python
# 按行业分组，每个行业选1只
financial_stocks = filter_by_industry(stock_pool, 'finance')
tech_stocks = filter_by_industry(stock_pool, 'tech')
...
```

### 4. 回测优化

**滚动训练**：

```python
# 每月重新训练模型
for month in backtest_period:
    train_data = recent_1_year_data(month)
    model = train_model(train_data)
    backtest(model, month)
```

**Walk-Forward 验证**：

```python
# 移动窗口验证
for i in range(0, total_months, 3):
    train_period = months[i:i+12]   # 12个月训练
    test_period = months[i+12:i+15] # 3个月测试
    results.append(backtest(train_period, test_period))
```

**多市场环境测试**：

- 牛市（2019-2021）
- 熊市（2022）
- 震荡市（2023-2025）

---

## 注意事项

### 数据质量

- ⚠️ 幸存者偏差：使用当前成分股回测历史数据，未考虑退市股
- ⚠️ 停牌处理：停牌股票无法交易，实盘可能无法复现回测
- ⚠️ 数据更新：沪深 300 成分股每半年调整（6 月、12 月），需定期更新

### 模型有效性

- ⚠️ 过拟合风险：训练集准确率过高，测试集表现差
- ⚠️ 市场 regime 变化：历史规律在未来可能失效
- ⚠️ 特征相关性：高相关特征可能导致多重共线性

### 实盘差异

- ⚠️ 滑点：实际成交价可能偏离开盘价
- ⚠️ 冲击成本：大单会推动价格，回测未考虑
- ⚠️ 涨跌停：无法在涨停买入、跌停卖出
- ⚠️ 时间延迟：信号产生到下单有延迟

### 风险提示

- ⚠️ 历史表现不代表未来收益
- ⚠️ 量化策略存在失效风险
- ⚠️ 市场系统性风险无法规避
- ⚠️ 建议小资金试运行，逐步验证

---

## 参考文献

1. Breiman, L. (2001). Random forests. Machine learning, 45(1), 5-32.
2. Fama, E. F., & French, K. R. (1992). The cross-section of expected stock returns. the Journal of Finance, 47(2), 427-465.
3. Jegadeesh, N., & Titman, S. (1993). Returns to buying winners and selling losers: Implications for stock market efficiency. The Journal of finance, 48(1), 65-91.

---

## 更新日志

**v2.0** (2025-11-22)

- 更换股票池：中证 100 → 沪深 300
- 新增特征有效性分析模块
- 优化回测输出格式（分割线标识持仓期）
- 新增特征相关性热图和重要性可视化

**v1.0** (2025-11-21)

- 初始版本
- 基于随机森林的选股策略
- 中证 100 股票池
- 基础回测功能

---

## 联系方式

**项目地址**: `c:\Users\Jinze Wang\Desktop\quant\`
**主要文件**: `final_strategy.py`, `hs300_stocks.py`, `download_stock_data_baostock.py`
**文档版本**: v2.0
**最后更新**: 2025-11-22
