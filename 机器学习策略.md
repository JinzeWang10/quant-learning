# 机器学习结合趋势与反转策略入门

本篇介绍如何将机器学习方法应用于**趋势跟随（Trend Following）** 与 **均值回归（Mean Reversion）** 策略中。
目标是从“手工规则”过渡到“数据驱动”，让模型自动学习趋势与反转信号。

---

## 一、背景与动机

传统量化策略往往依赖人为设定的规则，如：

- 趋势策略：`MA10 上穿 MA60 → 做多`
- 均值回归策略：`RSI < 30 → 买入`

但这些规则存在局限：

- 阈值和周期难以优化；
- 不同市场环境下失效；
- 无法捕捉复杂的非线性关系。

机器学习（ML）可以帮助我们：

- 从历史数据中**自动学习有效信号**；
- 识别**趋势持续或反转的概率**；
- 动态调整仓位，实现**数据驱动的择时**。

---

## 二、总体思路

### 1️⃣ 问题转化

我们可以把量化策略建模为一个 **监督学习问题（Supervised Learning）**：

| 类型     | 输入 (Features)                | 输出 (Label)             |
| -------- | ------------------------------ | ------------------------ |
| 趋势预测 | 技术指标、价格序列、成交量特征 | 下一期价格涨跌（1 或 0） |
| 反转预测 | 当前过热/超卖信号、价差偏离    | 未来 N 天收益率符号      |

即：**模型预测未来一段时间的走势方向**，然后根据概率结果决定买卖。

### 2️⃣ 流程概览

```
数据收集 → 特征构建 → 标签定义 → 模型训练 → 策略生成 → 回测评估
```

---

## 三、特征工程（Feature Engineering）

### 1. 技术指标特征

提取趋势与反转相关的特征输入模型：

- 均线差：`MA(short) - MA(long)`
- RSI、MACD、KDJ
- 布林带位置：`(Price - Lower) / (Upper - Lower)`
- 波动率指标：`Rolling Std`, `ATR`
- 成交量变化率：`ΔVolume / Volume[-1]`

### 2. 价格动量特征

- 过去 n 日收益率：`(Close_t / Close_{t-n}) - 1`
- 相对强度：`Return_t / MarketReturn_t`

### 3. 均值回归特征

- Z-score 价差：`(Price - MA) / Std`
- 布林带偏离度：`Price - MiddleBand`
- 短期 vs 长期收益率差：`R(5d) - R(20d)`

### 4. 目标变量（Label）

- **二分类标签**：`Label = 1` 若未来 5 日收益率 > 0，否则 `0`；
- **回归标签**：`Label = future_return_5d`。

---

## 四、模型选择

常见机器学习模型及适用场景：

| 模型                | 说明               | 优点                     | 典型用途         |
| ------------------- | ------------------ | ------------------------ | ---------------- |
| Logistic Regression | 基础线性分类器     | 可解释性强               | 二分类趋势预测   |
| Random Forest       | 集成树模型         | 处理非线性好             | 趋势/反转识别    |
| XGBoost / LightGBM  | 强大的梯度提升模型 | 泛化性强、特征重要性分析 | 主流量化预测模型 |
| SVM                 | 支持向量机         | 对小样本表现好           | 高频趋势识别     |
| LSTM / GRU          | 深度学习时序模型   | 捕捉长期依赖             | 中高频趋势预测   |

推荐顺序：
**Logistic → RandomForest → XGBoost → LSTM（进阶）**

---

## 五、策略生成与执行

### 1️⃣ 预测信号转化为交易决策

根据模型输出的上涨概率 `P_up`：

- 若 `P_up > 0.6` → 买入；
- 若 `P_up < 0.4` → 卖出；
- 其他情况 → 空仓或持仓不变。

### 2️⃣ 动态仓位控制

可按预测置信度调整仓位权重：

```
Position = 2 * (P_up - 0.5)
```

- 当模型信心越高，仓位越大；
- 趋势与反转策略均可采用此思想。

---

## 六、回测与评估

### 1. 评估指标

- **收益类**：累计收益率、年化收益率
- **风险类**：最大回撤、波动率
- **风险调整后收益**：Sharpe Ratio、Sortino Ratio
- **预测性能**：Accuracy、Precision、Recall、AUC

### 2. 验证方法

- 时间序列交叉验证（Time-Series CV）
- 滚动训练（Walk-Forward Validation）
- Out-of-sample 测试与过拟合检测

---

## 七、实例：用 XGBoost 做趋势预测

### 样例代码结构

```python
import pandas as pd
import numpy as np
from xgboost import XGBClassifier
from sklearn.metrics import accuracy_score
from sklearn.model_selection import TimeSeriesSplit

# 1. 构建特征
df['ma_short'] = df['close'].rolling(10).mean()
df['ma_long'] = df['close'].rolling(60).mean()
df['ma_diff'] = df['ma_short'] - df['ma_long']
df['rsi'] = talib.RSI(df['close'], timeperiod=14)
df['future_ret'] = df['close'].shift(-5) / df['close'] - 1
df['label'] = (df['future_ret'] > 0).astype(int)

# 2. 训练模型
features = ['ma_diff', 'rsi']
model = XGBClassifier(max_depth=3, n_estimators=100)
tscv = TimeSeriesSplit(n_splits=5)

for train_idx, test_idx in tscv.split(df):
    X_train, X_test = df[features].iloc[train_idx], df[features].iloc[test_idx]
    y_train, y_test = df['label'].iloc[train_idx], df['label'].iloc[test_idx]
    model.fit(X_train, y_train)
    y_pred = model.predict(X_test)
    print("Fold accuracy:", accuracy_score(y_test, y_pred))

# 3. 生成信号与回测
df['pred'] = model.predict_proba(df[features])[:, 1]
df['signal'] = np.where(df['pred'] > 0.6, 1, np.where(df['pred'] < 0.4, -1, 0))
```

可在 `Backtrader` 或自建框架中加载信号进行回测。

---

## 八、扩展方向

- **特征增强**：引入宏观指标、新闻情绪、资金流特征；
- **模型融合**：Blending / Stacking 提升稳定性；
- **强化学习（RL）**：用智能体动态调整仓位；
- **在线学习**：模型随时间更新，适应新市场结构。

---

## 九、总结

| 内容         | 趋势策略                     | 均值回归策略       |
| ------------ | ---------------------------- | ------------------ |
| 目标         | 捕捉延续走势                 | 把握反弹/回落      |
| 核心特征     | 动量、突破、均线差           | 偏离度、Z-score    |
| 典型模型     | XGBoost、LSTM                | Random Forest、SVM |
| 风险点       | 震荡期失效                   | 趋势期失效         |
| 机器学习优势 | 自动提取特征、提高信号鲁棒性 | 动态识别市场状态   |

---

> 💡 **建议**：
> 初学者可先用 XGBoost 实现一个“趋势方向二分类模型”，在 A 股日线或期货分钟级数据上回测效果；熟练后再尝试 LSTM、强化学习等高级方法。

---

📁 推荐路径：

```
quant-learning/
├── data/
├── notebooks/
│   ├── 01_trend_ml.ipynb
│   ├── 02_meanreversion_ml.ipynb
├── docs/
│   ├── ml-trend-reversion.md   ← 当前文档
│   ├── trend-strategy.md
│   ├── meanreversion-strategy.md
```
