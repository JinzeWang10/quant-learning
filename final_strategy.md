# 基于随机森林的最优选股策略

## 策略概述

本策略基于随机森林机器学习模型，每日通过预测上涨概率进行选股，选择当日预测概率最高且超过阈值的单只股票进行交易。这是一个保守的单股票轮动策略。

## 策略逻辑

### 核心思想

通过机器学习模型预测每只股票未来上涨的概率，在众多候选股票中选择**最优的一只**进行投资，而非分散持仓。这种策略追求集中度和确定性。

### 交易规则

#### 买入规则

1. **前置条件**：当前无持仓或已卖出持仓
2. **候选筛选**：
   - 计算股票池中所有股票的上涨概率
   - 筛选出上涨概率 > 60% 的股票
3. **最优选择**：
   - 从候选股票中选择**上涨概率最高**的那只
   - 使用 95%的可用资金买入（保留 5%现金应对手续费等）
4. **买入执行**：
   - 按 100 股整数倍买入
   - 记录买入日期、价格、概率

#### 卖出规则

1. **持仓监控**：每日计算当前持仓股票的上涨概率
2. **卖出触发**：当上涨概率 < 50% 时，清仓卖出
3. **卖出执行**：全部卖出，释放资金等待下一次买入机会

### 策略参数

| 参数             | 值           | 说明             |
| ---------------- | ------------ | ---------------- |
| `buy_threshold`  | 0.60 (60%)   | 买入概率阈值     |
| `sell_threshold` | 0.50 (50%)   | 卖出概率阈值     |
| `max_positions`  | 1            | 最大持仓股票数   |
| `position_ratio` | 0.95 (95%)   | 单只股票仓位比例 |
| `commission`     | 0.001 (0.1%) | 交易手续费率     |
| `initial_cash`   | 100,000      | 初始资金（元）   |

## 机器学习模型

### 模型类型

- **算法**：Random Forest Classifier（随机森林分类器）
- **参数**：
  - `n_estimators`: 100（决策树数量）
  - `max_depth`: 10（最大树深度）
  - `random_state`: 42（随机种子）

### 特征工程

模型使用 8 个技术指标作为特征：

| 特征名称        | 计算方式                                   | 含义                     |
| --------------- | ------------------------------------------ | ------------------------ |
| `return_1d`     | 1 日收益率                                 | 短期动量                 |
| `return_5d`     | 5 日收益率                                 | 中期动量                 |
| `return_10d`    | 10 日收益率                                | 长期动量                 |
| `ma_ratio_5_20` | MA5 / MA20                                 | 均线位置关系             |
| `volume_ratio`  | 当日成交量 / 5 日平均成交量                | 成交量放大倍数           |
| `rsi`           | 14 日 RSI                                  | 超买超卖指标             |
| `volatility`    | 20 日收益率标准差                          | 波动率                   |
| `bb_position`   | 布林带位置 = (价格 - 下轨) / (上轨 - 下轨) | 价格在布林带中的相对位置 |

### 标签定义

- **正样本（label=1）**：未来 5 日涨幅 > 3%
- **负样本（label=0）**：未来 5 日涨幅 ≤ 3%

### 模型输出

- **predict_proba(X)[0][1]**：返回股票属于正样本（上涨）的概率，范围 [0, 1]
- 概率越高，表示模型认为该股票未来 5 日上涨超过 3%的可能性越大

## 数据划分

为避免数据泄露（look-ahead bias），严格按时间序列划分：

| 数据集     | 时间范围                | 用途                       |
| ---------- | ----------------------- | -------------------------- |
| **训练集** | 2022-01-01 ~ 2025-06-30 | 训练随机森林模型           |
| **回测期** | 2025-07-01 ~ 2025-11-21 | 模拟真实交易，验证策略收益 |

**重要**：模型训练时不能使用未来数据，回测期必须与测试期一致或在测试期之后。

## 策略优势

### 1. 集中投资，高确定性

- 每次只买 1 只股票，资金集中度高
- 只买概率最高的股票，追求确定性而非分散

### 2. 风险控制

- 概率阈值过滤：只买概率>60%的股票
- 止损机制：概率<50%立即止损
- 单股票仓位限制：避免过度杠杆

### 3. 动态调仓

- 每日重新评估持仓概率
- 及时止损，及时换股
- 避免死守亏损股票

### 4. 数据驱动

- 基于历史数据训练，而非主观判断
- 量化指标，消除情绪影响
- 可回测，可优化

## 策略劣势与风险

### 1. 单股票风险

- 没有分散投资，单股票波动会直接影响账户
- 如果选错股票，损失可能较大

### 2. 换手率较高

- 每日评估，可能频繁换股
- 交易成本（手续费、印花税）累积

### 3. 模型局限性

- 随机森林基于历史数据，无法预测黑天鹅事件
- 市场环境变化时，历史规律可能失效
- 模型准确率有限（通常 50-60%）

### 4. 参数敏感性

- 阈值设置（60%买入，50%卖出）需要优化
- 不同市场环境下最优参数可能不同

## 回测指标

### 收益指标

- **总收益率**：(最终资金 - 初始资金) / 初始资金
- **年化收益率**：总收益率 × (365 / 回测天数)
- **最大回撤**：回测期内最大的资金回撤幅度

### 交易指标

- **交易次数**：买入次数 + 卖出次数
- **胜率**：盈利交易次数 / 总交易次数
- **平均持仓天数**：总持仓天数 / 交易次数
- **平均单笔收益**：总收益 / 交易次数

### 风险指标

- **夏普比率**：(年化收益率 - 无风险利率) / 收益率标准差
- **最大回撤**：max((峰值 - 当前值) / 峰值)
- **波动率**：日收益率的标准差 × √252

## 使用流程

### 1. 准备数据

```bash
# 下载股票历史数据到 stock_data/ 目录
python download_stock_data_baostock.py
```

### 2. 训练模型 + 回测

```bash
# 运行策略脚本，自动完成训练和回测
python rf_best_stock_strategy.py
```

### 3. 查看结果

- **终端输出**：

  - 模型训练准确率
  - 回测收益率
  - 交易明细（前 10 笔买入/卖出）

- **可视化图表**：
  - 账户价值曲线
  - 买入/卖出标记点
  - 累计收益率曲线

### 4. 参数优化（可选）

```python
# 修改策略参数进行优化
buy_threshold = 0.65  # 提高买入阈值，更保守
sell_threshold = 0.45  # 降低卖出阈值，更激进止损
position_ratio = 0.90  # 降低仓位，保留更多现金
```

## 改进方向

### 1. 特征优化

- 增加更多技术指标（MACD、KDJ、OBV 等）
- 引入基本面数据（PE、PB、ROE 等）
- 特征选择，去除冗余特征

### 2. 模型优化

- 尝试其他算法（XGBoost、LightGBM、神经网络）
- 超参数调优（网格搜索、贝叶斯优化）
- 集成学习，融合多个模型

### 3. 策略优化

- 动态调整阈值（根据市场环境）
- 增加止盈机制（涨幅达到 X%时止盈）
- 引入仓位管理（根据概率高低调整仓位）
- 多股票版本（持有 2-3 只概率最高的股票）

### 4. 风险控制

- 设置最大回撤止损（如回撤>20%时暂停交易）
- 设置单日最大亏损（如单日亏损>5%时停止）
- 引入波动率过滤（波动率过高时不买入）

## 代码文件结构

```
quant/
├── rf_best_stock_strategy.py      # 主策略文件（新建）
├── rf_best_stock_strategy.md      # 策略说明文档（本文件）
├── rf_stock_selector.py           # RF选股模型（复用）
├── stock_data/                    # 股票历史数据目录
│   ├── 000001_平安银行.csv
│   ├── 600036_招商银行.csv
│   └── ...
└── rf_model_ts.pkl                # 训练好的模型文件（自动生成）
```

## 免责声明

⚠️ **本策略仅供学习和研究使用，不构成投资建议。**

- 历史回测收益不代表未来收益
- 实盘交易存在滑点、流动性等因素
- 量化策略存在失效风险
- 股市有风险，投资需谨慎

---

**策略版本**：v1.0
**创建日期**：2025-11-21
**适用市场**：A 股
**回测框架**：Backtrader
**机器学习**：scikit-learn
